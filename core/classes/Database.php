<?php

    /* MVC
    
        Model
        View
        Controller

        Model - dados/base de dados
        View - Layout + html + css + bootstrap 5
        Controller - Regras de negócio 

    */

    // ===========================================================
    // Carregar Classes
        namespace core\classes;

        use Exception;
        use PDO;
        use PDOException;
    // ===========================================================

    // =========================================================== 
    // Classe Database
        class Database
        {
            // ============================================================
            // connect / connect
                private $connection;
                private function connect()
                {
                    // ===========================================================
                    // connect à base de dados
                        $this->connection = new PDO(
                            'mysql:'.
                            'host='.MYSQL_SERVER.';'.
                            'dbname='.MYSQL_DATABASE.';'.
                            'charset='.MYSQL_CHARSET,
                            MYSQL_USER,
                            MYSQL_PASS,
                            array(PDO::ATTR_PERSISTENT => true)
                        );
                    // ===========================================================
                    
                    // ===========================================================
                    // debug
                        $this->connection->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_WARNING);
                    // ===========================================================
                }
            // ============================================================    

            // ============================================================
            // disconnect
                private function disconnect()
                {
                    // ===========================================================
                    // desliga-se da base de dados
                        $this->connection = null;
                    // ===========================================================
                }
            // ============================================================

            // ============================================================
            // CRUD
                // ============================================================
                // select
                    public function select($sql, $parameters = null)
                    {
                        // ============================================================
                        // eliminar os espaços da instrucao
                            $sql = trim($sql);
                        // ============================================================

                        // ============================================================
                        // verifica se a instrução não é um SELECT
                            if(!preg_match("/^SELECT/i", $sql))
                            {
                                throw new Exception('Base de dados - Não é uma instrução SELECT.');
                            }
                        // ============================================================

                        // ============================================================
                        // connect bd
                            $this->connect();
                        // ============================================================

                        // ============================================================
                        // tentativa de comunicacao com a bd
                            $resultados = null;
                            try 
                            {
                                // ============================================================
                                // comunicação com a bd
                                    if(!empty($parameters))
                                    {
                                        // ============================================================
                                        // consulta com parameters
                                            $executar = $this->connection->prepare($sql);
                                            $executar->execute($parameters);
                                            $resultados = $executar->fetchAll(PDO::FETCH_CLASS);
                                        // ============================================================
                                    } 
                                    else 
                                    {
                                        // ============================================================
                                        // consulta sem parameters
                                            $executar = $this->connection->prepare($sql);
                                            $executar->execute();
                                            $resultados = $executar->fetchAll(PDO::FETCH_CLASS);
                                        // ============================================================

                                    }
                                // ============================================================
                            } 
                            catch (PDOException $e) 
                            {
                                // ============================================================
                                // caso exista erro
                                    return false;
                                // ============================================================
                            }
                        // ============================================================

                        // ============================================================
                        // desliga da bd
                            $this->disconnect();
                        // ============================================================

                        // ============================================================
                        // devolve os resultados obtidos
                            return $resultados;
                        // ============================================================
                    }
                // ============================================================        

                // ============================================================
                // insert
                    public function insert($sql, $parameters = null)
                    {
                        
                        // ============================================================
                        // eliminar os espaços da instrucao
                            $sql = trim($sql);
                        // ============================================================
                        
                        // ============================================================
                        // verifica se a instrução não é um INSERT
                            if(!preg_match("/^INSERT/i", $sql))
                            {
                                throw new Exception('Base de dados - Não é uma instrução INSERT.');
                            }
                        // ============================================================
                        
                        // ============================================================   
                        // liga bd
                            $this->connect();
                        // ============================================================

                        // ============================================================
                        // tenta comunicar com a bd
                            try 
                            {
                                // ============================================================
                                // comunicação com a bd
                                    if(!empty($parameters))
                                    {
                                        // ============================================================
                                        // comunicação com parameters
                                            $executar = $this->connection->prepare($sql);
                                            
                                            $executar->execute($parameters);
                                           //// Store::printData($executar);
                                        // ============================================================
                                    } 
                                    else 
                                    {
                                        // ============================================================
                                        // comunicação sem parameters
                                            $executar = $this->connection->prepare($sql);
                                            $executar->execute();
                                        // ============================================================
                                    }
                                // ============================================================
                            } 
                            catch (PDOException $e) 
                            {
                                // ============================================================
                                // caso exista erro
                                    return false;
                                // ============================================================
                            }
                        // ============================================================

                        // ============================================================
                        // disconnect a bd
                            $this->disconnect();
                        // ============================================================
                    }
                // ============================================================

                // ============================================================
                // update
                    public function update($sql, $parameters = null)
                    {

                        // ============================================================
                        // eliminar os espaços da instrucao
                            $sql = trim($sql);
                        // ============================================================
                        
                        // ============================================================
                        // verifica se é uma instrução UPDATE
                            if(!preg_match("/^UPDATE/i", $sql))
                            {
                                throw new Exception('Base de dados - Não é uma instrução UPDATE.');
                            }
                        // ============================================================

                        // ============================================================
                        // liga bd
                            $this->connect();
                        // ============================================================

                        // ============================================================
                        // tenta comunicar com a bd
                            try 
                            {
                                // ============================================================
                                // comunicação com a bd
                                    if(!empty($parameters))
                                    {
                                        $executar = $this->connection->prepare($sql);
                                        $executar->execute($parameters);
                                    } 
                                    else 
                                    {
                                        $executar = $this->connection->prepare($sql);
                                        $executar->execute();
                                    }
                                // ============================================================
                            } 
                            catch (PDOException $e) 
                            {
                                // ============================================================
                                // caso exista erro
                                    return false;
                                // ============================================================
                            }
                        // ============================================================

                        // ============================================================
                        // desliga da bd
                            $this->disconnect();
                        // ============================================================
                    }
                // ============================================================        

                // ============================================================
                // delete
                    public function delete($sql, $parameters = null)
                    {
                        // ============================================================
                        // eliminar os espaços da instrucao
                            $sql = trim($sql);
                        // ============================================================

                        // ============================================================
                        // verifica se é uma instrução DELETE
                            if(!preg_match("/^DELETE/i", $sql))
                            {
                                throw new Exception('Base de dados - Não é uma instrução DELETE.');
                            }
                        // ============================================================

                        // ============================================================
                        // connect à bd
                            $this->connect();
                        // ============================================================

                        // ============================================================
                        // tenta comunicar com a bd
                            try 
                            {
                                // ============================================================
                                // avaliar se existem parameters na instrucao
                                    if(!empty($parameters))
                                    {
                                        // ============================================================
                                        // comunicação com a bd com parameters
                                            $executar = $this->connection->prepare($sql);
                                            $executar->execute($parameters);
                                        // ============================================================
                                    } 
                                    else 
                                    {
                                        // ============================================================
                                        // comunicação com a bd sem parameters
                                            $executar = $this->connection->prepare($sql);
                                            $executar->execute();
                                        // ============================================================
                                    }
                                // ============================================================
                            } 
                            catch (PDOException $e) 
                            {
                                // ============================================================
                                // caso exista devolve erro
                                    return false;
                                // ============================================================
                            }
                        // ============================================================

                        // ============================================================
                        // desliga da bd
                                $this->disconnect();
                        // ============================================================
                    }
                // ============================================================  
            // ============================================================

            // ============================================================
            // GENÉRICA
                // ============================================================
                // statement
                    public function statement($sql, $parameters = null)
                    {
                        // ============================================================
                        // eliminar os espaços da instrucao
                            $sql = trim($sql);
                        // ============================================================ 
                        
                        // ============================================================
                        // verifica se é uma instrução diferente das anteriores
                            if(preg_match("/^(SELECT|INSERT|UPDATE|DELETE)/i", $sql))
                            {
                                throw new Exception('Base de dados - Instrução inválida.');
                            }
                        // ============================================================

                        // ============================================================
                        // connect à bd
                            $this->connect();
                        // ============================================================

                        // ============================================================
                        // tentativa de comunicar com a bd
                            try 
                            {
                                // ============================================================
                                // avaliar se existem parameters na instrucao
                                    if(!empty($parameters))
                                    {
                                        // ============================================================
                                        //  comunicação com a bd com parameters
                                            $executar = $this->connection->prepare($sql);
                                            $executar->execute($parameters);
                                        // ============================================================
                                    } 
                                    else 
                                    {
                                        // ============================================================
                                        // comunicação com a bd sem parameters
                                            $executar = $this->connection->prepare($sql);
                                            $executar->execute();
                                        // ============================================================
                                    }
                                // ============================================================
                            } 
                            catch (PDOException $e) 
                            {
                                // ============================================================
                                // caso exista erro
                                    return false;
                                // ============================================================
                            }
                        // ============================================================

                        // ============================================================
                        // desliga da bd
                            $this->disconnect();
                        // ============================================================
                    }
                // ============================================================
            // ============================================================

        }
    // =========================================================== 